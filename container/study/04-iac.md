## インフラ構築が変わる Infrastructure as Code

ここで言う「インフラ構築」は、  
IaaS を操作してアプリケーションの実行環境を構築することです。  
物理環境の構築のことを指しません。  

## Infrastructure as Code (IaC) とは？

IaC とは、「インフラやミドルウェアをコードで管理する」というものです。  
具体的には、構成情報をテキストファイルやプログラムコードで管理をし、  
構成情報をシステムが直接参照してインフラ構築を行うものを指します。

## 今までの構築方法

従来のインフラ構築は、以下の手順を実施していました。  

1. AWS コンソールをポチポチしてインスタンスを起動させる
2. インスタンスに ssh でログイン
3. Wordpress 構築作業
4. 設定が正しいか確認する

手順3の Wordpress 構築作業は、更に細かく分けると以下の作業を実施しています。  

1. nginx インストール
2. php, php-fpm インストール
3. nginx.conf を設定する

これらの作業は、以下の観点で課題があると言えます。  

- 様々な設定情報をドキュメント化する必要がある
  - インスタンス起動パラメータ
  - nginx, php, php-fpm のインストール手順やバージョン
  - nginx.conf の設定情報
  - php のパラメータ
- ドキュメントの生存期間が短いことが予想される
  - AWS に更新があって、新しい設定値を利用しないといけなくなった
  - nginx のディレクティブが非推奨になった
  - ミドルウェアのバージョンが変わった、パッケージングの方式が変わった
- ドキュメントどおりの状態が保たれない可能性がある
  - 検証作業を実施してそのままになっている
  - 緊急対応を実施してそのままになっている
  - オペミスで設定が違っている



## IaC があると？

順番通り演習を進めているみなさんは、すでに IaC を実践しています。  

![image](../images/docker-compose.png)

`docker-compose.yaml` というテキストファイルを用いて、  
php や nginx などのミドルウェアの管理をしています。
そして、`docker-compose` コマンドで `docker-compose.yml` を直接読み込んでコンテナの構築を行っていますね。  
Docker Compose があると、構築作業は以下の手順となります。  

1. `docker-compose up -d`

便利！

## コードで管理する利点

コードで管理すると、どんないいことがあるでしょうか？

### 誰が実行しても同じ結果になる

`docker-compose up -d ` やるだけなら、間違える人は少ないですね。  
ただ、php の設定や nginx の設定をコピペしたりしていると、  
ミスが発生する可能性は少しばかり上がります。  

### アプリケーション開発のプラクティスが流用できる

アプリケーションと同じテキストファイル形式で管理できるため、git が使えます。  
git が使えるということは、PR によるコードレビューや、  
ボットによるマージからの自動適用などを設定できます。  

## 管理するレイヤ

管理するレイヤによって、それぞれ得意なソフトウェアがあります。  

![image](../images/triangle.png)

Docker が得意なレイヤは、  
Rails などのアプリケーションの部分や、Ruby などのランタイムのレイヤです。  
Docker が動くためのマシン（VM）や、通信するためのネットワークの管理は得意ではありません。  

それらのレイヤを得意とするソフトウェアが、Terraform です。


## Terraform

AWS をコードで管理できるソフトウェアです。  
他の人が作ったライブラリを使ったり、設定が意図したものか確認する機能があったりします。  
AWS 以外に、GCP もペパボで利用している OpenStack も操作できます。  

## コードで管理する際に意識する考え方

コードで管理する際には、「べき等性」を意識することが大事です。  
プログラミングするときにも必要な考え方です。

### べき等性とは？

何度実行しても同じ答えが導き出せる性質を持つものを、
「べき等である」というふうに表現します。  

`1 + 1` は必ず2が返ってくるのでべき等ですね。  
ruby の `Time.new` は、実行のたびに現在時刻が返ってくるためべき等ではありません。  


### なぜべき等でないといけないのか？

#### 実行タイミングで状態があわなくなってしまう

べき等が担保されていないと、  
「このサーバって適用して良いんだっけ？」という疑問が生まれてしまいます。  
そうなると、維持が難しくなってしまいます。  
何も考えずに適用すれば最新になる、という状態なら実行する人も安心ですし、  
ボットによる自動化もできますね。  
